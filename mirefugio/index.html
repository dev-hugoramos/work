<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Espacio Seguro - Una aplicación inteligente de apoyo emocional que te ayuda a entender y procesar tus sentimientos con IA avanzada">
    <meta name="keywords" content="salud mental, emociones, bienestar, apoyo emocional, terapia, IA, inteligencia artificial">
    <meta name="author" content="Hugo Ramos Espino">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Espacio Seguro - Apoyo Emocional Inteligente">
    <meta property="og:description" content="Una aplicación inteligente que te ayuda a entender y procesar tus emociones con análisis de IA avanzado">
    <meta property="og:type" content="website">
    <title>Espacio Seguro - Apoyo Emocional Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
        }

        .app-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 30%, #f093fb 70%, #f5576c 100%);
            position: relative;
        }

        .floating-circle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            animation: float 20s infinite ease-in-out;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-100px)
            }
        }

        .content-wrapper {
            position: relative;
            z-index: 10;
            padding: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header-section {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 20px 20px 0 0;
        }

        .header-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
        }

        .result-card {
            margin-top: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 20px;
        }

        .emotion-badge {
            display: inline-block;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            font-weight: 600;
            margin: 10px 0;
        }

        .empathy-message {
            font-size: 1.3rem;
            line-height: 1.8;
            margin: 1.5rem 0;
        }

        .alert-help {
            background: rgba(255, 59, 48, 0.9);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .music-control {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }

        .music-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            visibility: hidden;
        }

        .fade {
            transition: opacity 0.6s ease;
            opacity: 1;
        }

        .fade-leave-active {
            opacity: 0;
        }

        .insights-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .insights-header h5 {
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .insights-content {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
        }

        .insight-item {
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .emotion-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }

        .history-preview {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .emotion-timeline {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .emotion-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .emotion-dot:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .smart-suggestions {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .suggestion-item {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            transition: transform 0.2s ease;
        }

        .suggestion-item:hover {
            transform: translateX(5px);
        }

        .suggestion-item:last-child {
            margin-bottom: 0;
        }

        .volume-control {
            margin-top: 10px;
        }

        .volume-slider {
            width: 80px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        /* Mejoras para móviles */
        @media (max-width: 768px) {
            .app-container {
                padding: 0;
            }

            .content-wrapper {
                padding: 1rem;
            }

            .header-section h1 {
                font-size: 2rem;
            }

            .card {
                margin: 0;
                border-radius: 15px;
            }

            .card-body {
                padding: 1.5rem !important;
            }

            .btn-lg {
                font-size: 1rem;
                padding: 0.75rem 1rem;
            }

            .music-control {
                bottom: 20px;
                right: 20px;
            }

            .music-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .empathy-message {
                font-size: 1.1rem;
                line-height: 1.6;
            }

            .insights-card {
                padding: 1rem;
            }

            .smart-suggestions {
                padding: 1rem;
            }

            .result-card {
                padding: 1.5rem;
            }

            .floating-circle {
                display: none;
            }

            .btn {
                margin-bottom: 0.5rem;
                width: 100%;
            }

            .btn + .btn {
                margin-left: 0;
            }
        }

        @media (max-width: 480px) {
            .header-section h1 {
                font-size: 1.8rem;
            }

            .empathy-message {
                font-size: 1rem;
            }

            .insights-card,
            .smart-suggestions {
                padding: 0.8rem;
            }

            .music-control {
                bottom: 15px;
                right: 15px;
            }

            .music-btn {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
        }

        /* Animaciones suaves */
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 25px 70px rgba(0, 0, 0, 0.4);
        }

        .btn {
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .suggestion-item {
            transition: all 0.3s ease;
        }

        .suggestion-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.3);
        }

        /* Mejoras de accesibilidad */
        .btn:focus,
        input:focus,
        textarea:focus {
            outline: 2px solid #fff;
            outline-offset: 2px;
        }

        /* Efectos de carga mejorados */
        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.3rem;
        }

        /* Mejoras visuales adicionales */
        .emotion-badge {
            font-size: 1.1rem;
            padding: 12px 24px;
        }

        .confidence-bar {
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
        }

        .confidence-fill {
            background: linear-gradient(90deg, #4CAF50, #8BC34A, #FFD700);
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="app-container">
            <div class="floating-circle" :style="{width:'200px',height:'200px',top:'10%',left:'5%'}"></div>
            <div class="floating-circle" :style="{width:'150px',height:'150px',top:'60%',right:'10%'}"></div>

            <div class="content-wrapper">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="header-section">
                                    <h1>🌟 Mi Refugio 🌟</h1>
                                    <p class="mb-0">Un lugar donde tus emociones importan</p>
                                </div>
                                <div class="card-body p-4">
                                    <!-- Nombre -->
                                    <div v-if="!nameSubmitted">
                                        <label class="form-label fw-bold" for="nameInput">¿Cuál es tu nombre?</label>
                                        <input v-model="name" type="text" class="form-control" id="nameInput"
                                            placeholder="Escribe tu nombre..." @keyup.enter="submitName"
                                            aria-describedby="nameHelp" autocomplete="name">
                                        <div id="nameHelp" class="form-text">Tu nombre nos ayuda a personalizar tu experiencia</div>
                                        <button @click="submitName" class="btn btn-primary w-100 mt-3"
                                            :disabled="!name.trim()" aria-label="Continuar con el nombre ingresado">✨ Continuar</button>
                                    </div>

                                    <!-- Sentimientos -->
                                    <div v-if="nameSubmitted && !submitted">
                                        <p class="text-muted">👋 Hola, <strong>{{ name }}</strong></p>
                                        <label class="form-label fw-bold" for="feelingInput">¿Cómo te sientes hoy?</label>
                                        <textarea v-model="feeling" class="form-control" rows="4" id="feelingInput"
                                            placeholder="Comparte lo que sientes..." ref="feelingInput"
                                            aria-describedby="feelingHelp" autocomplete="off"></textarea>
                                        <div id="feelingHelp" class="form-text">Describe libremente tus emociones, pensamientos o experiencias</div>
                                        <button @click="analyzeEmotion" class="btn btn-primary w-100 mt-3"
                                            :disabled="!feeling || loading" aria-label="Analizar mis sentimientos">
                                            <span v-if="!loading">💬 Compartir mis sentimientos</span>
                                            <span v-else>Analizando...</span>
                                        </button>
                                    </div>

                                    <div v-if="loading" class="text-center py-4">
                                        <div class="spinner-border text-primary"></div>
                                        <p class="mt-2">Comprendiendo tus emociones...</p>
                                    </div>

                                    <!-- Resultado -->
                                    <div v-if="result && !loading">
                                        <div id="captureArea" class="result-card">
                                            <div class="text-center mb-3">
                                                <div class="emotion-badge">
                                                    <span class="emotion-indicator" :style="{backgroundColor: emotionMap[result.emotion]?.color}"></span>
                                                    {{ emotionEmoji }} {{ emotionLabel }}
                                                    <span v-if="result.confidence" class="ms-2">
                                                        ({{ Math.round(result.confidence * 100) }}% confianza)
                                                    </span>
                                                </div>
                                                <div v-if="result.confidence" class="confidence-bar mt-2">
                                                    <div class="confidence-fill" :style="{width: (result.confidence * 100) + '%'}"></div>
                                                </div>
                                            </div>
                                            <div class="empathy-message" v-if="result && !loading"
                                                v-bind:class="{ fade: fadeEffect }">
                                                {{ empathyMessage }}
                                            </div>
                                            <div class="text-center mt-4">
                                                <small>💝 Para: {{ name }}</small>
                                                <div v-if="quote" class="mt-2"><em>"{{ quote }}"</em></div>
                                                
                                                <!-- Vista previa del historial emocional -->
                                                <div v-if="userHistory.length > 1" class="history-preview">
                                                    <small><strong>📊 Tu viaje emocional reciente:</strong></small>
                                                    <div class="emotion-timeline">
                                                        <div v-for="(entry, index) in userHistory.slice(-7)" 
                                                             :key="index"
                                                             class="emotion-dot" 
                                                             :style="{backgroundColor: emotionMap[entry.emotion]?.color}"
                                                             :title="`${emotionMap[entry.emotion]?.label} - ${new Date(entry.timestamp).toLocaleDateString()}`">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Insights Inteligentes -->
                                        <div v-if="aiInsights" class="insights-card mt-3">
                                            <div class="insights-header">
                                                <h5>🧠 Insights sobre tu bienestar emocional</h5>
                                            </div>
                                            <div class="insights-content">
                                                <div class="insight-item">
                                                    <strong>Tendencia:</strong> 
                                                    <span :class="{
                                                        'text-success': aiInsights.trend === 'positivo',
                                                        'text-warning': aiInsights.trend === 'neutral',
                                                        'text-danger': aiInsights.trend === 'negativo'
                                                    }">
                                                        {{ aiInsights.trend === 'positivo' ? '📈 Mejorando' : 
                                                           aiInsights.trend === 'negativo' ? '📉 Necesita atención' : '📊 Estable' }}
                                                    </span>
                                                </div>
                                                <div v-if="aiInsights.pattern" class="insight-item">
                                                    <strong>Patrón emocional:</strong> 
                                                    <span :class="{
                                                        'text-success': aiInsights.pattern === 'mejorando',
                                                        'text-warning': aiInsights.pattern === 'estable',
                                                        'text-danger': aiInsights.pattern === 'empeorando'
                                                    }">
                                                        {{ aiInsights.pattern === 'mejorando' ? '✨ Progreso positivo' : 
                                                           aiInsights.pattern === 'empeorando' ? '⚠️ Considera apoyo' : '🔄 Estable' }}
                                                    </span>
                                                </div>
                                                <div class="insight-item">
                                                    <strong>Recomendación personalizada:</strong>
                                                    <p class="mb-0">{{ aiInsights.recommendation }}</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div v-if="needsHelp" class="alert alert-help">
                                            <h5>🤗 Hay gente aquí para ayudarte:</h5>
                                            <p>Si estás pasando por un momento difícil, no estás solo/a:</p>
                                            <ul>
                                                <li><strong>🚨 Emergencias:</strong> 911</li>
                                                <li><strong>Línea de la Vida (México):</strong> 800 911 2000</li>
                                                <li><strong>SAPTEL (Suicidio):</strong> 55 5259 8121</li>
                                                <li><strong>Crisis Text Line:</strong> Envía HOME al 741741</li>
                                                <li><strong>Línea de Ayuda Psicológica:</strong> 800 911 2000</li>
                                            </ul>
                                            <p class="mb-0"><strong>Recuerda:</strong> Tu vida tiene valor. Busca ayuda profesional. No tienes que enfrentar esto solo/a. 💙</p>
                                        </div>

                                        <!-- Sugerencias Inteligentes -->
                                        <div v-if="result" class="smart-suggestions">
                                            <h6>💡 Sugerencias personalizadas para ti</h6>
                                            <div class="suggestion-item" v-for="suggestion in getSmartSuggestions()" :key="suggestion">
                                                {{ suggestion }}
                                            </div>
                                        </div>

                                        <div class="text-center mt-4">
                                            <button @click="saveAsImage" class="btn btn-success btn-lg me-2">📸 Guardar
                                                frase</button>
                                            <button @click="reset" class="btn btn-outline-secondary btn-lg">🔄 Nuevo
                                                sentimiento</button>
                                            <button v-if="userHistory.length > 0" @click="viewHistory" class="btn btn-info btn-lg ms-2">📈 Ver historial</button>
                                        </div>
                                        
                                        <!-- Opciones adicionales -->
                                        <div v-if="userHistory.length > 0" class="text-center mt-3">
                                            <small class="text-muted">Opciones de privacidad:</small><br>
                                            <button @click="exportData" class="btn btn-sm btn-outline-primary me-2">📁 Exportar datos</button>
                                            <button @click="clearHistory" class="btn btn-sm btn-outline-danger">🗑️ Limpiar historial</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Footer -->
                            <div class="text-center text-white mt-4">
                                <p class="mb-2">💻 Desarrollado con ❤️ por <strong>Hugo Ramos Espino</strong></p>
                                <a href="https://ko-fi.com/hugoramos" target="_blank" class="btn btn-sm"
                                    style="background: #FF5E5B; color: white; border-radius: 10px; text-decoration: none; padding: 8px 20px; font-weight: 600;">
                                    ☕ Apóyame en Ko-fi
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Música -->
            <div class="music-control">
                <button @click="toggleMusic" class="music-btn" :title="isPlaying ? 'Pausar música' : 'Reproducir música'">
                    {{ isPlaying ? '🔊' : '🔇' }}
                </button>
                <div class="volume-control" v-if="isPlaying">
                    <input type="range" min="0" max="1" step="0.1" v-model="musicVolume" 
                           @input="updateVolume" class="volume-slider" title="Control de volumen">
                </div>
            </div>
        </div>

        <!-- Audio dinámico -->
        <audio ref="bgMusic" :src="currentMusic" loop preload="auto" @ended="nextTrack"></audio>

    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    name: '',
                    feeling: '',
                    submitted: false,
                    loading: false,
                    result: null,
                    isPlaying: false,
                    nameSubmitted: false,
                    userHistory: JSON.parse(localStorage.getItem('emotionHistory') || '[]'),
                    currentMood: JSON.parse(localStorage.getItem('currentMood') || 'null'),
                    aiInsights: null,
                    currentMusic: null,
                    musicVolume: 0.3,
                    emotionMap: {
                        'joy': { label: 'Alegría', emoji: '😊', type: 'positive', color: '#FFD93D' },
                        'sadness': { label: 'Tristeza', emoji: '😢', type: 'negative', color: '#6C7CE7' },
                        'anger': { label: 'Enojo', emoji: '😠', type: 'negative', color: '#FF6B6B' },
                        'fear': { label: 'Miedo', emoji: '😨', type: 'negative', color: '#8E44AD' },
                        'love': { label: 'Amor', emoji: '❤️', type: 'positive', color: '#FF69B4' },
                        'surprise': { label: 'Sorpresa', emoji: '😮', type: 'neutral', color: '#FFA726' },
                        'neutral': { label: 'Neutral', emoji: '😐', type: 'neutral', color: '#95A5A6' },
                        'anxiety': { label: 'Ansiedad', emoji: '😰', type: 'negative', color: '#9B59B6' },
                        'excitement': { label: 'Emoción', emoji: '🤩', type: 'positive', color: '#F39C12' },
                        'gratitude': { label: 'Gratitud', emoji: '🙏', type: 'positive', color: '#27AE60' },
                        'confusion': { label: 'Confusión', emoji: '😕', type: 'neutral', color: '#95A5A6' },
                        'hopeful': { label: 'Esperanza', emoji: '🌟', type: 'positive', color: '#3498DB' }
                    },
                    empathyPhrases: {
                        'joy': [
                            '¡{name}, qué alegría tan inmensa saber que estás radiante! Tu energía positiva es contagiosa y el mundo necesita más personas como tú. Estos momentos de felicidad son tesoros que debes guardar en tu corazón. Recuerda siempre que mereces cada instante de esta dicha, y que tu sonrisa tiene el poder de iluminar incluso los días más oscuros de quienes te rodean. ¡Sigue brillando con esa luz única que llevas dentro! 🌟✨',
                            '{name}, es maravilloso ver cómo la alegría fluye a través de ti. Este sentimiento tan hermoso que experimentas es una muestra de tu capacidad para apreciar las cosas buenas de la vida. No permitas que nada ni nadie apague esa chispa especial que te caracteriza. Comparte esta felicidad con el mundo, porque tu energía positiva puede transformar vidas. Eres una bendición y mereces celebrar cada victoria, por pequeña que parezca. ¡Que esta alegría se multiplique en tu vida! 💫🌈',
                            '¡Qué hermoso es verte así de feliz, {name}! La vida te está sonriendo y tú le estás devolviendo la sonrisa. Este momento de plenitud que estás viviendo es el resultado de tu valentía, tu perseverancia y tu capacidad de ver el lado bueno de las cosas. Guarda este sentimiento en tu memoria para esos días en que las cosas se pongan difíciles. Eres luz pura, y el universo conspira a tu favor. ¡Sigue adelante con esa actitud tan inspiradora! 🎉💖'
                        ],
                        'sadness': [
                            '{name}, mi corazón está contigo en este momento tan difícil. La tristeza que sientes es profunda y completamente válida. No hay prisa por "estar bien", date el tiempo que necesites para procesar lo que estás viviendo. Llorar no es señal de debilidad, sino de valentía al permitirte sentir. Aunque ahora parezca imposible, te prometo que este dolor no será eterno. Poco a poco, encontrarás luz en medio de la oscuridad. Eres increíblemente fuerte, incluso en tu vulnerabilidad. No estás solo/a en esto, hay personas que se preocupan por ti profundamente. Permítete recibir apoyo y amor. Los días mejores llegarán, paso a paso. 💙🤗',
                            'Querido/a {name}, puedo sentir el peso de la tristeza que cargas en este momento, y quiero que sepas que está bien sentirse así. No tienes que fingir estar bien para nadie. La vida nos presenta momentos oscuros, pero justamente esos momentos nos enseñan sobre nuestra propia fortaleza. Sé gentil contigo mismo/a, date permiso para sanar a tu propio ritmo. Recuerda que esta tormenta pasará, y cuando lo haga, saldrás de ella siendo una versión más sabia y resiliente de ti. Aunque no lo veas ahora, hay esperanza esperándote. Mereces amor, comprensión y días llenos de paz. Te abrazo desde la distancia. 🌙💜',
                            '{name}, siento mucho que estés atravesando este momento de dolor. La tristeza puede sentirse como un océano interminable, pero quiero recordarte algo importante: has sobrevivido al 100% de tus días más difíciles hasta ahora, y también superarás este. No estás roto/a, estás sanando. Cada lágrima que derramas es parte de tu proceso de liberación. Date tiempo, date espacio, date amor. Busca apoyo en quienes te quieren y, si lo necesitas, no dudes en pedir ayuda profesional. Tu valor no disminuye por estar pasando un mal momento. Eres valioso/a, importante y profundamente amado/a. La luz volverá a tu vida. 🌅💕'
                        ],
                        'anger': [
                            '{name}, veo que estás sintiendo mucha frustración y enojo, y quiero que sepas que tu emoción es completamente válida. Tienes derecho a sentirte así. Sin embargo, no permitas que este sentimiento te consuma por dentro. El enojo puede ser una fuerza destructiva o transformadora, y tú tienes el poder de elegir. Te invito a respirar profundamente, a alejarte de la situación si es posible, y a buscar formas saludables de canalizar esta energía. Quizás escribir, hacer ejercicio, o hablar con alguien de confianza. Recuerda que responder con calma no significa que no estés molesto/a, significa que tienes el control. Eres más grande que este momento de ira. 🌬️💪',
                            'Querido/a {name}, entiendo perfectamente tu frustración y enojo. A veces la vida nos pone en situaciones que nos hacen hervir la sangre, y está bien reconocer esos sentimientos. Pero quiero recordarte algo: tú no eres tu enojo, eres mucho más que esta emoción temporal. Este sentimiento pasará, pero las decisiones que tomes mientras estés enojado/a podrían tener consecuencias duraderas. Tómate un momento, respira, cuenta hasta diez si es necesario. Canaliza esa energía poderosa hacia algo constructivo. Tu paz mental es más valiosa que tener la razón o vengarte. Eres capaz de transformar esta tormenta en crecimiento personal. 🧘✨',
                            '{name}, puedo percibir la intensidad de lo que estás sintiendo ahora mismo. El enojo es una emoción humana natural, pero no dejes que te controle. Tienes todo el derecho de estar molesto/a, pero también tienes el poder de elegir cómo responder. Pregúntate: ¿esta situación seguirá siendo importante en 5 años? A veces, dar un paso atrás nos ayuda a ver las cosas con perspectiva. Busca formas saludables de liberar esa energía: camina, corre, grita en un lugar seguro si lo necesitas. Tu bienestar emocional es prioritario. Eres fuerte, sabio/a y capaz de navegar esta tormenta con gracia. 🔥🕊️'
                        ],
                        'fear': [
                            '{name}, reconocer tu miedo ya es un acto de valentía increíble. El miedo es una emoción natural que nos protege, pero no debemos dejar que nos paralice. Lo que estás sintiendo es real y válido, pero quiero que recuerdes algo fundamental: has enfrentado miedos antes y has salido victorioso/a. Eres más fuerte de lo que crees. El miedo solo tiene el poder que tú le das. Respira profundo, da un paso a la vez, y verás cómo ese monstruo que parece gigante se hace más pequeño con cada avance. No estás solo en esto. Confía en ti, confía en el proceso, y recuerda que al otro lado del miedo está tu crecimiento. 🦋💫',
                            'Querido/a {name}, puedo sentir la ansiedad y el miedo que estás experimentando en este momento. Es una sensación abrumadora, lo sé, pero quiero que sepas algo: el miedo no define tu futuro, solo muestra que te importa. Ese temor que sientes es evidencia de que estás a punto de crecer, de expandirte más allá de tu zona de confort. Los guerreros más valientes no son aquellos que no sienten miedo, sino aquellos que avanzan a pesar de él. Tú eres ese guerrero/a. Cada paso que das, por pequeño que sea, es una victoria. Respira, centra tu mente, y recuerda que tienes todo lo necesario dentro de ti para superar esto. 🌟💪',
                            '{name}, el miedo que sientes ahora mismo es intenso, pero temporal. Quiero recordarte que algunos de tus mayores logros en la vida han venido después de momentos de gran temor. El miedo es solo una emoción, no es una profecía. No te dice lo que va a pasar, solo te muestra lo mucho que te importa el resultado. Permítete sentir ese miedo, acéptalo, pero no dejes que tome las decisiones por ti. Eres infinitamente más poderoso/a que cualquier miedo. Busca apoyo si lo necesitas, habla sobre lo que sientes, y da un paso a la vez. La valentía no es la ausencia de miedo, es actuar a pesar de él. Y tú eres valiente. 🌈✨'
                        ],
                        'love': [
                            '¡{name}, qué hermoso es el amor que estás sintiendo! Este sentimiento tan puro y poderoso que habita en tu corazón es uno de los regalos más preciosos de la vida. El amor, en cualquiera de sus formas, tiene el poder de transformar, sanar y dar sentido a nuestra existencia. Cultiva ese amor con cuidado, protégelo, pero también compártelo sin miedo. Eres un ser lleno de luz y capacidad de amar profundamente, y eso es algo extraordinario. Permítete vivir este sentimiento plenamente, sin reservas, porque el amor verdadero siempre merece ser celebrado. Que este amor te llene de alegría y te inspire a ser la mejor versión de ti mismo/a. ❤️💕',
                            '{name}, el amor que sientes en este momento es mágico y transformador. Ya sea amor romántico, familiar, de amistad o amor propio, este sentimiento es la fuerza más poderosa del universo. Alimenta ese amor con acciones conscientes, palabras amables y presencia genuina. Recuerda que amar también es un acto de valentía, porque nos hace vulnerables, pero también nos hace humanos. Disfruta cada momento, cada conversación, cada gesto de afecto. Eres digno/a de dar y recibir amor abundante. Que este sentimiento siga creciendo en tu vida. 🌹✨',
                            '¡Qué maravilloso, {name}! El amor que estás experimentando es la evidencia de que tu corazón está abierto y dispuesto a conectar profundamente. Este sentimiento tan especial merece ser honrado y cuidado. No tengas miedo de expresar lo que sientes, de mostrar tu vulnerabilidad, porque ahí es donde reside la verdadera fuerza del amor. Ya sea amor hacia otra persona, hacia tu familia, tus amigos, o hacia ti mismo/a, este sentimiento es el que da color y significado a nuestra existencia. Permítete vivirlo plenamente, sin miedo al futuro. El presente es tuyo, y está lleno de amor. 💖🌟'
                        ],
                        'surprise': [
                            '¡{name}, qué emocionante es vivir momentos inesperados! La vida tiene una forma mágica de sorprendernos justo cuando menos lo esperamos. Esta sensación de asombro que estás sintiendo es un recordatorio hermoso de que la vida está llena de posibilidades infinitas. Mantén tu mente abierta y tu corazón receptivo a todo lo que el universo tiene preparado para ti. Las mejores historias que contaremos en el futuro son aquellas que nunca vimos venir. Disfruta de esta sorpresa, aprende de ella, y permítele que agregue un nuevo matiz a tu historia personal. Eres parte de algo más grande y maravilloso. ✨🎉',
                            'Querido/a {name}, las sorpresas son los condimentos que hacen que la vida sea verdaderamente interesante. Este momento inesperado que estás viviendo tiene algo que enseñarte, algo que mostrarte sobre ti mismo/a o sobre el mundo. Abraza lo desconocido con curiosidad y entusiasmo. La vida es impredecible, y esa es precisamente su belleza. Cada sorpresa es una oportunidad para crecer, para ver las cosas desde una nueva perspectiva, para expandir tu comprensión del mundo. Disfruta este momento, documéntalo en tu memoria, y permite que enriquezca tu experiencia de vida. ¡El universo siempre tiene algo extraordinario preparado para ti! 🌈💫',
                            '{name}, ¡qué hermoso es dejarse sorprender por la vida! Este momento inesperado que estás experimentando es una prueba de que la vida siempre encuentra formas de maravillarnos. Mantén esa capacidad de asombro, esa chispa de curiosidad que te caracteriza. Las personas que pueden sorprenderse son aquellas que permanecen jóvenes de espíritu sin importar su edad. Aprovecha esta energía renovada para hacer algo diferente, para atreverte a explorar nuevos caminos. La sorpresa es el recordatorio del universo de que siempre hay más por descubrir, más por vivir, más por amar. ¡Disfruta el viaje! 🎊✨'
                        ],
                        'neutral': [
                            '{name}, los días tranquilos también tienen su propia belleza y propósito. No todos los días tienen que ser una montaña rusa de emociones, y está perfectamente bien sentirse en equilibrio. Este momento de calma que estás experimentando te permite reflexionar, recargar energías y prepararte para lo que venga. Aprovecha esta serenidad para agradecer lo que tienes, organizar tus pensamientos y conectar contigo mismo/a. La vida no siempre necesita grandes emociones para ser significativa; a veces, la quietud es suficiente para nutrir el alma. 🌿🕊️',
                            'Querido/a {name}, el sentirse neutral o tranquilo es un regalo que muchas veces pasa desapercibido. Estos momentos de equilibrio nos permiten respirar, reorganizar nuestras ideas y disfrutar de la vida sin presión. Aprovecha esta oportunidad para conectar contigo mismo, para hacer algo que te guste y que te nutra internamente. La neutralidad no es ausencia de emoción, es un espacio para la claridad y la introspección. Date permiso de disfrutarlo sin culpa ni expectativas. 💛✨',
                            '{name}, estar en un estado neutral es una forma de equilibrio que la vida nos ofrece. No todos los momentos necesitan ser intensos para ser valiosos. Esta calma te permite observar tu entorno, cuidar de ti mismo/a y planificar tus próximos pasos con claridad. La neutralidad es un momento de pausa, de preparación, de reflexión. Disfruta de este estado, aprecia la tranquilidad y usa este tiempo para fortalecerte y conectar contigo y con los que te rodean. 🌸🕊️'
                        ],
                        'anxiety': [
                            '{name}, puedo sentir la ansiedad que te está acompañando en este momento. Es una sensación intensa y real, y quiero que sepas que no estás solo en esto. La ansiedad es como una tormenta en tu mente, pero como todas las tormentas, pasará. Respira profundamente conmigo: inhala lentamente por la nariz, siente cómo se llena tu pecho, y exhala suavemente por la boca. Repite esto contigo mismo. Eres más fuerte que esta ansiedad, aunque ahora no lo sientas así. Date permiso de ir paso a paso, sin presionarte. 🌊💙',
                            'Querido/a {name}, la ansiedad puede sentirse como un laberinto sin salida, pero quiero recordarte algo importante: has enfrentado momentos difíciles antes y has salido adelante. Esta ansiedad que sientes ahora es temporal, aunque parezca eterna. Intenta la técnica 5-4-3-2-1: nombra 5 cosas que puedes ver, 4 que puedes tocar, 3 que puedes oír, 2 que puedes oler, 1 que puedes saborear. Esto te ayudará a anclarte en el presente. Eres valiente por reconocer lo que sientes. 🌸💪',
                            '{name}, siento mucho que estés experimentando ansiedad en este momento. Es una emoción muy intensa y puede sentirse abrumadora. Quiero que sepas que es completamente normal sentirse así, y que no hay nada malo en ti por experimentar ansiedad. Prueba hacer ejercicios de respiración, caminar un poco, o hacer algo que te guste. Si la ansiedad persiste, no dudes en buscar ayuda profesional. Tu bienestar mental es tan importante como tu salud física. Mereces paz y tranquilidad. 🕊️💜'
                        ],
                        'excitement': [
                            '¡{name}, qué maravilloso es sentir esta emoción tan intensa! La emoción es como un fuego que ilumina tu alma y te llena de energía positiva. Aprovecha esta sensación para hacer algo que realmente te apasione. Cuando estamos emocionados, somos capaces de lograr cosas increíbles. Canaliza esta energía hacia tus objetivos, tus sueños, hacia lo que realmente te importa. La vida te está regalando este momento de entusiasmo, ¡disfrútalo al máximo! 🚀✨',
                            '{name}, la emoción que sientes ahora mismo es pura magia. Es esa sensación que nos recuerda que estamos vivos y que la vida está llena de posibilidades infinitas. No dejes que esta energía se desperdicie. Úsala para crear, para explorar, para atreverte a hacer algo nuevo. La emoción es combustible para el alma, y tú tienes un tanque lleno. ¡Qué hermoso es verte así de radiante! 🌟💫',
                            '¡Qué hermoso verte tan emocionado/a, {name}! Esta energía positiva que irradias es contagiosa y transformadora. La emoción es uno de los regalos más preciosos de la vida, y cuando la sentimos, todo parece posible. Aprovecha este momento para hacer algo que te haga feliz, para compartir tu alegría con otros, o para dar el siguiente paso hacia algo que realmente deseas. Tu entusiasmo es tu superpoder. ¡Úsalo sabiamente! 🎉💖'
                        ],
                        'gratitude': [
                            '{name}, qué hermoso es sentir gratitud en tu corazón. Esta emoción tan pura y transformadora tiene el poder de cambiar completamente tu perspectiva de la vida. La gratitud no solo es un sentimiento, es una práctica que puede transformar tu mundo. Cada vez que sientes gratitud, estás reconociendo la abundancia que ya existe en tu vida. Sigue cultivando este sentimiento, compártelo con otros, y verás cómo se multiplica la belleza a tu alrededor. Eres un ser lleno de luz y apreciación. 🙏✨',
                            'Querido/a {name}, la gratitud que sientes ahora mismo es como una semilla que has plantado en tu corazón y que está floreciendo. Es hermoso ver cómo reconoces las bendiciones en tu vida, por pequeñas que parezcan. La gratitud nos conecta con lo esencial, con lo que realmente importa. Escribe sobre lo que agradeces, comparte tu gratitud con quienes amas, y observa cómo esta práctica transforma tu día a día. Eres un ejemplo de cómo vivir con el corazón abierto. 🌸💝',
                            '{name}, sentir gratitud es uno de los regalos más hermosos que puedes darte a ti mismo/a. Esta emoción te conecta con la abundancia de la vida y te recuerda todo lo bueno que ya tienes. La gratitud es como un imán que atrae más cosas buenas hacia ti. No solo estás agradecido/a, estás practicando una forma de vida que te llena de paz y satisfacción. Sigue reconociendo las pequeñas y grandes bendiciones que te rodean. Eres un ser lleno de sabiduría y amor. 🌺💕'
                        ],
                        'confusion': [
                            '{name}, es completamente normal sentirse confundido/a a veces. La confusión no es un signo de debilidad, sino una señal de que estás procesando información nueva o navegando por una situación compleja. Date permiso de no tener todas las respuestas inmediatamente. A veces, la claridad llega cuando menos la esperamos. Tómate el tiempo que necesites para reflexionar, haz preguntas si puedes, y recuerda que no tienes que resolver todo de una vez. La confusión es solo una parada temporal en tu camino hacia la comprensión. 🌫️💙',
                            'Querido/a {name}, la confusión puede sentirse como estar perdido en una niebla, pero quiero recordarte que las mejores respuestas a menudo vienen después de momentos de incertidumbre. No te presiones por entender todo de inmediato. A veces, la vida nos presenta situaciones que requieren tiempo para procesar. Habla con alguien de confianza, escribe tus pensamientos, o simplemente date espacio para sentir sin necesidad de entender. La claridad llegará cuando estés listo/a para recibirla. 🌅🤔',
                            '{name}, sentir confusión es parte natural del proceso de aprendizaje y crecimiento. No significa que hayas hecho algo mal o que no seas lo suficientemente inteligente. De hecho, reconocer que estás confundido/a muestra que eres consciente y que te importa encontrar la respuesta correcta. Date tiempo, sé paciente contigo mismo/a, y no tengas miedo de pedir ayuda si la necesitas. Cada momento de confusión es una oportunidad para aprender algo nuevo sobre ti y el mundo que te rodea. 🧭💫'
                        ],
                        'hopeful': [
                            '¡{name}, qué hermoso es sentir esperanza en tu corazón! La esperanza es como una estrella que brilla incluso en la noche más oscura. Es esa chispa de luz que nos recuerda que siempre hay posibilidades, que siempre hay algo por lo que luchar. Tu esperanza no es ingenua, es valiente. Es la decisión consciente de creer en un futuro mejor, incluso cuando el presente es difícil. Mantén esa esperanza viva, aliméntala con acciones pequeñas cada día, y verás cómo se convierte en realidad. 🌟💫',
                            'Querido/a {name}, la esperanza que sientes es uno de los regalos más preciosos que puedes tener. No es solo un sentimiento, es una fuerza que puede mover montañas. Cuando tienes esperanza, tienes poder para crear el cambio que deseas ver en tu vida. La esperanza te da la fuerza para seguir adelante cuando las cosas se ponen difíciles. Comparte tu esperanza con otros, porque es contagiosa y puede iluminar el camino de quienes te rodean. Eres un faro de luz en este mundo. 🕯️✨',
                            '{name}, sentir esperanza es como tener un jardín secreto en tu corazón donde las flores más hermosas pueden florecer. Es esa certeza interna de que las cosas pueden mejorar, de que hay un mañana lleno de posibilidades. Tu esperanza no es fantasía, es fe en tu propia capacidad de crear y atraer cosas buenas a tu vida. Cada día que eliges la esperanza sobre el miedo, estás eligiendo la vida. Sigue creyendo, sigue esperando, porque tu esperanza es el primer paso hacia la realización de tus sueños. 🌈💖'
                        ]
                    },
                    musicPlaylist: {
                        'joy': [
                            'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                            // Música alegre y energética
                        ],
                        'sadness': [
                            'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                            // Música calmante y consoladora
                        ],
                        'anger': [
                            'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                            // Música relajante para canalizar la energía
                        ],
                        'fear': [
                            'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                            // Música tranquilizadora
                        ],
                        'love': [
                            'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                            // Música romántica y cálida
                        ],
                        'anxiety': [
                            'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                            // Música de meditación y relajación
                        ],
                        'gratitude': [
                            'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                            // Música inspiradora y elevadora
                        ],
                        'hopeful': [
                            'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                            // Música optimista y motivadora
                        ],
                        'neutral': [
                            'https://www.soundjay.com/misc/sounds/bell-ringing-05.wav',
                            // Música ambiente suave
                        ]
                    }
                }
            },
            computed: {
                emotionLabel() {
                    if (!this.result) return '';
                    return this.emotionMap[this.result.emotion]?.label || 'Emoción';
                },
                emotionEmoji() {
                    if (!this.result) return '';
                    return this.emotionMap[this.result.emotion]?.emoji || '😊';
                },
                empathyMessage() {
                    if (!this.result) return '';
                    const message = this.generateEmpathyResponse(this.result.emotion, this.feeling);
                    //this.speakMessage(message);
                    return message;
                },
                needsHelp() {
                    if (!this.result) return false;
                    const negativeEmotions = ['sadness', 'anger', 'fear', 'anxiety'];
                    const crisisKeywords = ['suicidio', 'suicidar', 'matarme', 'no quiero vivir', 'cáncer', 'enfermo', 'tumor'];
                    const hasCrisisKeywords = crisisKeywords.some(keyword => 
                        this.feeling.toLowerCase().includes(keyword)
                    );
                    return (negativeEmotions.includes(this.result.emotion) && this.result.score > 0.7) || hasCrisisKeywords;
                },
                emotionalTrend() {
                    if (this.userHistory.length < 3) return 'insuficiente';
                    const recent = this.userHistory.slice(-5);
                    const positiveCount = recent.filter(e => ['joy', 'love', 'gratitude', 'excitement', 'hopeful'].includes(e.emotion)).length;
                    const negativeCount = recent.filter(e => ['sadness', 'anger', 'fear', 'anxiety'].includes(e.emotion)).length;
                    
                    if (positiveCount > negativeCount + 1) return 'mejorando';
                    if (negativeCount > positiveCount + 1) return 'empeorando';
                    return 'estable';
                }
            },
            methods: {
                detectEmotionFromKeywords(text) {
                    const lowerText = text.toLowerCase();
                    const keywords = {
                        'sadness': ['triste', 'tristeza', 'deprimido', 'depresión', 'lloro', 'llorar', 'llorando', 'dolor', 'pérdida', 'muerte', 'murió', 'falleció', 'duelo', 'solo', 'sola', 'soledad', 'vacío', 'desesperado', 'desesperanza', 'melancolía', 'nostalgia', 'perdí', 'extraño', 'falta', 'abandonado', 'desanimado', 'sufro', 'sufrimiento'],
                        'anger': ['enojado', 'enojo', 'rabia', 'furioso', 'furia', 'molesto', 'irritado', 'frustrado', 'frustración', 'odio', 'coraje', 'enfadado', 'ira', 'injusto', 'injusticia', 'harto', 'cansado de', 'indignado', 'maldito', 'cabrón', 'no puedo más', 'me da rabia', 'estúpido', 'idiota'],
                        'fear': ['miedo', 'temor', 'asustado', 'aterrado', 'pánico', 'terror', 'angustia', 'angustiado', 'inseguro', 'inseguridad', 'amenaza', 'peligro', 'tengo miedo', 'me asusta', 'vulnerable'],
                        'anxiety': ['ansiedad', 'ansioso', 'nervioso', 'preocupado', 'preocupación', 'estrés', 'estresado', 'agobiado', 'agobio', 'presión', 'presionado', 'tensión', 'tenso'],
                        'joy': ['feliz', 'felicidad', 'alegre', 'alegría', 'contento', 'emocionado', 'emoción', 'dichoso', 'eufórico', 'radiante', 'maravilloso', 'genial', 'increíble', 'fantástico', 'excelente', 'bendecido', 'afortunado', 'celebrar', 'logré', 'conseguí', 'éxito', 'victoria'],
                        'love': ['amor', 'amo', 'quiero', 'cariño', 'te amo', 'enamorado', 'enamorada', 'adorar', 'adoro', 'pasión', 'afecto', 'romántico', 'corazón', 'beso', 'abrazo', 'pareja', 'novio', 'novia', 'esposo', 'esposa', 'familia'],
                        'gratitude': ['agradecido', 'agradecida', 'gracias', 'bendecido', 'bendecida', 'afortunado', 'afortunada', 'suerte', 'fortuna', 'agradezco', 'reconocimiento'],
                        'excitement': ['emocionado', 'emocionada', 'excitado', 'excitada', 'expectativa', 'anticipación', 'esperando', 'anhelando', 'deseando'],
                        'confusion': ['confundido', 'confundida', 'confusión', 'perdido', 'perdida', 'no entiendo', 'no sé', 'duda', 'dudoso', 'incierto'],
                        'hopeful': ['esperanza', 'esperanzado', 'esperanzada', 'optimista', 'positivo', 'positiva', 'fe', 'creer', 'confío']
                    };
                    
                    let scores = {};
                    for (let emotion in keywords) {
                        scores[emotion] = 0;
                    }
                    
                    // Análisis más inteligente con pesos
                    for (let emotion in keywords) {
                        keywords[emotion].forEach(keyword => {
                            const count = (lowerText.match(new RegExp(keyword, 'g')) || []).length;
                            scores[emotion] += count;
                        });
                    }
                    
                    // Detectar emociones complejas
                    const complexPatterns = {
                        'anxiety': /(?:muy|mucho|demasiado)\s+(?:ansioso|nervioso|preocupado)/,
                        'excitement': /(?:muy|mucho)\s+(?:emocionado|excitado)/,
                        'hopeful': /(?:tengo|siento)\s+(?:esperanza|fe)/
                    };
                    
                    for (let emotion in complexPatterns) {
                        if (complexPatterns[emotion].test(lowerText)) {
                            scores[emotion] += 2;
                        }
                    }
                    
                    // Analizar contexto emocional del historial
                    if (this.userHistory.length > 0) {
                        const recentEmotions = this.userHistory.slice(-3).map(entry => entry.emotion);
                        const emotionCounts = recentEmotions.reduce((acc, emotion) => {
                            acc[emotion] = (acc[emotion] || 0) + 1;
                            return acc;
                        }, {});
                        
                        // Dar peso a emociones recientes
                        for (let emotion in emotionCounts) {
                            if (scores[emotion]) {
                                scores[emotion] += emotionCounts[emotion] * 0.5;
                            }
                        }
                    }
                    
                    let maxScore = 0;
                    let detectedEmotion = 'neutral';
                    for (let emotion in scores) {
                        if (scores[emotion] > maxScore) {
                            maxScore = scores[emotion];
                            detectedEmotion = emotion;
                        }
                    }
                    
                    return { 
                        emotion: detectedEmotion, 
                        score: maxScore > 0 ? Math.min(0.9, 0.3 + (maxScore * 0.1)) : 0.3,
                        confidence: maxScore > 0 ? Math.min(1, maxScore / 3) : 0.3
                    };
                },
                submitName() {
                    if (!this.name.trim()) { alert('Por favor ingresa tu nombre'); return; }
                    this.nameSubmitted = true;
                    this.$nextTick(() => { if (this.$refs.feelingInput) this.$refs.feelingInput.focus(); });
                },
                async analyzeEmotion() {
                    if (!this.feeling.trim()) { alert('Por favor comparte cómo te sientes'); return; }
                    this.loading = true;
                    this.submitted = true;
                    try {
                        const keywordResult = this.detectEmotionFromKeywords(this.feeling);
                        let finalResult = keywordResult;
                        
                        // Intentar con API de IA si el análisis local no es muy confiable
                        if (keywordResult.confidence < 0.7) {
                            try {
                                const response = await fetch("https://api-inference.huggingface.co/models/finiteautomata/beto-emotion-analysis", {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({ inputs: this.feeling })
                                });
                                const data = await response.json();
                                if (data && data[0] && data[0].length > 0) {
                                    const topEmotion = data[0].reduce((prev, curr) => (prev.score > curr.score) ? prev : curr);
                                    const aiResult = { emotion: topEmotion.label.toLowerCase(), score: topEmotion.score, confidence: topEmotion.score };
                                    
                                    // Combinar resultados inteligentemente
                                    if (aiResult.score > keywordResult.score) {
                                        finalResult = aiResult;
                                    }
                                }
                            } catch (error) {
                                console.log('API no disponible, usando análisis local');
                            }
                        }
                        
                        this.result = finalResult;
                        
                        // Guardar en historial
                        const historyEntry = {
                            timestamp: new Date().toISOString(),
                            emotion: finalResult.emotion,
                            score: finalResult.score,
                            text: this.feeling,
                            name: this.name
                        };
                        
                        this.userHistory.push(historyEntry);
                        if (this.userHistory.length > 50) {
                            this.userHistory = this.userHistory.slice(-50); // Mantener solo los últimos 50
                        }
                        
                        localStorage.setItem('emotionHistory', JSON.stringify(this.userHistory));
                        localStorage.setItem('currentMood', JSON.stringify(finalResult));
                        
                        // Generar insights inteligentes
                        this.generateInsights();
                        
                        // Cambiar música según la emoción
                        this.changeMusicByEmotion(finalResult.emotion);
                        
                    } catch (e) { 
                        console.error(e); 
                        this.result = { emotion: 'neutral', score: 0.5, confidence: 0.3 }; 
                    }
                    finally { this.loading = false; }
                },
                generateInsights() {
                    if (this.userHistory.length < 3) return;
                    
                    const recentEntries = this.userHistory.slice(-7); // Últimos 7 días
                    const emotionCounts = {};
                    let totalScore = 0;
                    
                    recentEntries.forEach(entry => {
                        emotionCounts[entry.emotion] = (emotionCounts[entry.emotion] || 0) + 1;
                        totalScore += entry.score;
                    });
                    
                    const avgScore = totalScore / recentEntries.length;
                    const dominantEmotion = Object.keys(emotionCounts).reduce((a, b) => 
                        emotionCounts[a] > emotionCounts[b] ? a : b
                    );
                    
                    const insights = {
                        trend: avgScore > 0.6 ? 'positivo' : avgScore < 0.4 ? 'negativo' : 'neutral',
                        dominantEmotion: dominantEmotion,
                        pattern: this.detectEmotionalPattern(),
                        recommendation: this.getPersonalizedRecommendation(dominantEmotion, avgScore)
                    };
                    
                    this.aiInsights = insights;
                },
                
                detectEmotionalPattern() {
                    if (this.userHistory.length < 5) return null;
                    
                    const recent = this.userHistory.slice(-5).map(e => e.emotion);
                    const positiveEmotions = ['joy', 'love', 'gratitude', 'excitement', 'hopeful'];
                    const negativeEmotions = ['sadness', 'anger', 'fear', 'anxiety'];
                    
                    const positiveCount = recent.filter(e => positiveEmotions.includes(e)).length;
                    const negativeCount = recent.filter(e => negativeEmotions.includes(e)).length;
                    
                    if (positiveCount > negativeCount + 1) return 'mejorando';
                    if (negativeCount > positiveCount + 1) return 'empeorando';
                    return 'estable';
                },
                
                getPersonalizedRecommendation(dominantEmotion, avgScore) {
                    const recommendations = {
                        'sadness': 'Considera hablar con un profesional de salud mental. La terapia puede ayudarte a procesar estos sentimientos.',
                        'anxiety': 'Prueba técnicas de respiración profunda o meditación. El ejercicio regular también puede reducir la ansiedad.',
                        'anger': 'Encuentra formas saludables de expresar tu frustración, como ejercicio o arte.',
                        'fear': 'Recuerda que has superado desafíos antes. Eres más fuerte de lo que crees.',
                        'joy': '¡Qué maravilloso! Sigue cultivando estas emociones positivas.',
                        'love': 'El amor es una fuerza poderosa. Comparte estos sentimientos con quienes amas.',
                        'gratitude': 'La gratitud es una práctica transformadora. Mantén este hábito positivo.',
                        'hopeful': 'La esperanza es tu superpoder. Confía en el proceso de la vida.'
                    };
                    
                    return recommendations[dominantEmotion] || 'Continúa siendo consciente de tus emociones y busca apoyo cuando lo necesites.';
                },

                generateEmpathyResponse(emotion, text) {
                    const name = this.name || "Amigo/a";
                    text = text.toLowerCase();
                    
                    // DETECCIÓN DE CRISIS - RESPUESTAS URGENTES Y HUMANAS
                    const crisisKeywords = {
                        suicide: ['suicidio', 'suicidar', 'matarme', 'acabar con todo', 'no quiero vivir', 'terminar con mi vida', 'quitarse la vida'],
                        selfHarm: ['cortarme', 'lastimarme', 'herirme', 'dañarme', 'autolesión', 'dañarme a mí mismo'],
                        severeDepression: ['no puedo más', 'no aguanto', 'estoy acabado', 'sin esperanza', 'no hay salida', 'todo está perdido'],
                        crisis: ['crisis', 'emergencia', 'ayuda urgente', 'no sé qué hacer', 'desesperado', 'pánico total']
                    };
                    
                    // Detectar crisis de suicidio
                    if (crisisKeywords.suicide.some(keyword => text.includes(keyword))) {
                        return `${name}, mi corazón se detiene al leer tus palabras. Lo que estás sintiendo es real y doloroso, pero también temporal. Por favor, por favor, busca ayuda inmediatamente. Llama al 911 o a la Línea de la Vida (800 911 2000) AHORA MISMO. No estás solo/a en esto. Tu vida tiene valor, aunque ahora no puedas verlo. Hay gente que te ama y profesionales que pueden ayudarte. Por favor, no hagas nada irreversible. Tu dolor es válido, pero hay formas de sanarlo. Te abrazo con todo mi corazón. 💔🤗`;
                    }
                    
                    // Detectar autolesión
                    if (crisisKeywords.selfHarm.some(keyword => text.includes(keyword))) {
                        return `${name}, entiendo que el dolor que sientes es insoportable y que buscas formas de aliviarlo. Pero lastimarte no es la respuesta. Por favor, busca ayuda profesional inmediatamente. Puedes llamar al 911 o contactar a un terapeuta. Tu cuerpo y tu mente merecen cuidado y amor, no dolor. Hay formas más seguras de procesar estos sentimientos. No estás solo/a en esto. 💙🤗`;
                    }
                    
                    // Detectar depresión severa
                    if (crisisKeywords.severeDepression.some(keyword => text.includes(keyword))) {
                        return `${name}, puedo sentir la profundidad de tu dolor en cada palabra. Cuando todo parece oscuro y sin esperanza, es difícil ver la luz, pero existe. Por favor, considera hablar con un profesional de salud mental. La depresión es una enfermedad real y tratable. No tienes que enfrentarla sola/o. Tu vida importa, tu dolor es válido, y hay ayuda disponible. Por favor, busca apoyo profesional hoy mismo. 💜`;
                    }
                    
                    // Detectar crisis general
                    if (crisisKeywords.crisis.some(keyword => text.includes(keyword))) {
                        return `${name}, reconozco que estás en una crisis y que te sientes abrumado/a. Es valiente de tu parte expresarlo. En momentos así, es crucial buscar apoyo inmediato. Por favor, contacta a alguien de confianza, un profesional de salud mental, o llama a una línea de crisis. No tienes que enfrentar esto solo/a. Tu bienestar es prioritario. 🤗💙`;
                    }
                    
                    // Detectar enfermedades graves (cáncer, etc.)
                    const healthCrisis = ['cáncer', 'tumor', 'quimioterapia', 'enfermedad terminal', 'diagnóstico grave', 'operación mayor'];
                    if (healthCrisis.some(keyword => text.includes(keyword))) {
                        return `${name}, mi corazón se llena de compasión al leer sobre la situación de salud que estás enfrentando. Es normal sentir miedo, rabia, tristeza y una mezcla de emociones intensas. No tienes que ser fuerte todo el tiempo. Permítete sentir lo que sientes. Busca apoyo en grupos de apoyo, terapeutas especializados en oncología, o consejeros espirituales. No estás solo/a en este camino. Cada día que luchas es un acto de valentía. Te acompaño con todo mi amor. 💙🕊️`;
                    }
                    
                    // Detectar situaciones específicas para respuestas más personalizadas
                    const isLoss = text.includes("murió") || text.includes("falleció") || text.includes("muerte") || text.includes("perdí a");
                    const isAnxiety = text.includes("ansiedad") || text.includes("preocupado") || text.includes("nervioso") || text.includes("estrés");
                    const isLonely = text.includes("solo") || text.includes("sola") || text.includes("soledad") || text.includes("aislado");
                    const isSelfDoubt = text.includes("inútil") || text.includes("no sirvo") || text.includes("no valgo") || text.includes("fracaso");
                    const isRelationship = text.includes("pareja") || text.includes("novio") || text.includes("novia") || text.includes("relación");
                    const isWork = text.includes("trabajo") || text.includes("empleo") || text.includes("jefe") || text.includes("oficina");
                    
                    // Respuestas contextuales más inteligentes y humanas
                    if (isLoss) return `${name}, lamento profundamente tu pérdida. Perder a alguien que amamos es uno de los dolores más profundos que podemos experimentar. Es completamente normal sentir que el mundo se ha detenido. No hay un tiempo "correcto" para sanar. Permítete llorar, recordar, y honrar a esa persona especial. El amor que sientes por ella/él nunca desaparecerá, solo se transformará. No estás solo/a en este dolor. Te abrazo con todo mi corazón. 💜🕊️`;
                    
                    if (isAnxiety) return `${name}, puedo sentir cómo la ansiedad te está consumiendo. Es como tener una tormenta constante en tu mente, ¿verdad? Respira conmigo ahora: inhala lentamente por la nariz (1,2,3,4), mantén el aire (1,2,3,4), exhala suavemente por la boca (1,2,3,4,5,6). Repite esto tres veces. Recuerda: no tienes que controlar todo. Date permiso de vivir un día a la vez, un momento a la vez. Eres más fuerte de lo que crees, aunque ahora no lo sientas así. 🌿💙`;
                    
                    if (isLonely) return `${name}, la soledad puede sentirse como un peso que te aplasta el pecho. Pero quiero que sepas algo importante: no estás realmente solo/a. Hay personas que te aman más de lo que imaginas. Usa este momento para reconectarte contigo mismo/a, para recordar quién eres realmente. Y cuando estés listo/a, extiende la mano hacia alguien. Pedir compañía no te hace débil, te hace humano. Eres valioso/a, importante, y mereces amor y conexión. 💫🤗`;
                    
                    if (isSelfDoubt) return `${name}, escucha mi voz con atención: tu valor no se mide por tus logros, tus errores, o lo que otros piensen de ti. Tu valor es intrínseco, es parte de tu esencia. Eres único/a, irrepetible, y tienes algo especial que aportar al mundo que nadie más puede dar. Cuando la voz crítica en tu cabeza te ataque, recuerda: eres suficiente, tal como eres, en este momento exacto. Te amo y creo en ti. ❤️✨`;
                    
                    if (isRelationship) return `${name}, las relaciones del corazón pueden ser nuestro mayor gozo y también nuestra mayor fuente de dolor. Es completamente normal sentir emociones intensas cuando amamos a alguien. Date tiempo para procesar lo que sientes. La comunicación honesta y compasiva es la base de cualquier relación sana. Recuerda que amar no significa perderte a ti mismo/a. Eres digno/a de amor y respeto. 🌹💕`;
                    
                    if (isWork) return `${name}, entiendo la presión que puede generar el trabajo. Es fácil que se convierta en nuestra identidad, pero recuerda: tú no eres tu trabajo. Tu valor como persona trasciende cualquier logro profesional. Es importante encontrar equilibrio entre dedicación y autocuidado. Si el trabajo te está consumiendo, tal vez es momento de reevaluar prioridades. Tu bienestar emocional es más importante que cualquier trabajo. 🏢💙`;
                    
                    // Usar historial para personalizar respuesta
                    if (this.userHistory.length > 0) {
                        const lastEmotion = this.userHistory[this.userHistory.length - 1]?.emotion;
                        if (lastEmotion === emotion && this.userHistory.length > 1) {
                            return `${name}, veo que has estado luchando con ${this.emotionMap[emotion]?.label.toLowerCase()} recientemente. Es increíblemente valiente de tu parte seguir compartiendo tus sentimientos, incluso cuando es difícil. Cada vez que expresas lo que sientes, das un paso más hacia la sanación. No te rindas. Estoy aquí contigo en este viaje. 💪🤗`;
                        }
                    }
                    
                    // Respuesta estándar personalizada
                    const phrases = this.empathyPhrases[emotion] || this.empathyPhrases['neutral'];
                    return phrases[Math.floor(Math.random() * phrases.length)].replace('{name}', name);
                },
                toggleMusic() {
                    const audio = this.$refs.bgMusic;
                    if (this.isPlaying) { 
                        audio.pause(); 
                    } else { 
                        if (!this.currentMusic) {
                            this.changeMusicByEmotion('neutral');
                        }
                        audio.volume = this.musicVolume;
                        audio.play().catch(e => console.log('Error reproduciendo música:', e)); 
                    }
                    this.isPlaying = !this.isPlaying;
                },
                
                changeMusicByEmotion(emotion) {
                    const playlist = this.musicPlaylist[emotion] || this.musicPlaylist['neutral'];
                    if (playlist && playlist.length > 0) {
                        const randomTrack = playlist[Math.floor(Math.random() * playlist.length)];
                        this.currentMusic = randomTrack;
                        
                        // Si la música está reproduciéndose, cambiar de inmediato
                        if (this.isPlaying) {
                            const audio = this.$refs.bgMusic;
                            audio.src = randomTrack;
                            audio.volume = this.musicVolume;
                            audio.play().catch(e => console.log('Error cambiando música:', e));
                        }
                    }
                },
                
                updateVolume() {
                    const audio = this.$refs.bgMusic;
                    if (audio) {
                        audio.volume = this.musicVolume;
                    }
                },
                
                nextTrack() {
                    if (this.result && this.result.emotion) {
                        this.changeMusicByEmotion(this.result.emotion);
                    }
                },
                async saveAsImage() {
                    const element = document.getElementById('captureArea');
                    try {
                        const canvas = await html2canvas(element, { backgroundColor: null, scale: 2 });
                        const link = document.createElement('a');
                        link.download = `espacio-seguro-${this.name}.jpg`;
                        link.href = canvas.toDataURL('image/jpeg', 0.95);
                        link.click();
                    } catch (e) { console.error(e); alert('Hubo un error al guardar la imagen.'); }
                },
                reset() {
                    this.feeling = '';
                    this.submitted = false;
                    this.result = null;
                    this.$nextTick(() => { if (this.$refs.feelingInput) this.$refs.feelingInput.focus(); });
                },
                speakMessage(message) {
                    if (!('speechSynthesis' in window)) return;
                    const utterance = new SpeechSynthesisUtterance(message);
                    utterance.lang = 'es-ES';
                    window.speechSynthesis.cancel();
                    window.speechSynthesis.speak(utterance);
                },
                
                getSmartSuggestions() {
                    if (!this.result) return [];
                    
                    const emotion = this.result.emotion;
                    const suggestions = {
                        'sadness': [
                            '🎵 Escucha música que te haga sentir acompañado/a',
                            '📖 Lee algo inspirador o que te guste',
                            '🌱 Sal a caminar al aire libre, aunque sea por 10 minutos',
                            '📞 Llama a alguien en quien confíes para hablar',
                            '💧 Toma un baño relajante o una ducha caliente'
                        ],
                        'anxiety': [
                            '🫁 Practica la respiración 4-7-8: inhala 4, mantén 7, exhala 8',
                            '🧘 Prueba meditación guiada de 5 minutos',
                            '🏃‍♀️ Haz ejercicio ligero para liberar endorfinas',
                            '📝 Escribe tus preocupaciones para organizar tus pensamientos',
                            '🎨 Colorea o dibuja para calmar tu mente'
                        ],
                        'anger': [
                            '👊 Golpea una almohada de forma segura',
                            '🏃‍♂️ Sal a correr o haz ejercicio intenso',
                            '🎵 Escucha música que te relaje',
                            '🌊 Ve a un lugar con agua (playa, lago, río)',
                            '💬 Habla con alguien de confianza sobre lo que sientes'
                        ],
                        'fear': [
                            '📝 Escribe lo que te asusta y por qué',
                            '🫂 Abraza a alguien cercano o abraza una almohada',
                            '🎬 Mira algo divertido que te distraiga',
                            '🏠 Crea un espacio seguro y cómodo para ti',
                            '💪 Recuerda momentos difíciles que ya superaste'
                        ],
                        'joy': [
                            '🎉 Comparte tu felicidad con alguien más',
                            '📸 Toma una foto para recordar este momento',
                            '🎵 Baila con tu música favorita',
                            '🌟 Haz algo bueno por otra persona',
                            '📝 Escribe en un diario de gratitud'
                        ],
                        'love': [
                            '💌 Expresa tu amor a quien amas',
                            '🌹 Haz algo especial para tu ser querido',
                            '📸 Crea recuerdos juntos',
                            '💝 Escribe una carta de amor',
                            '🎨 Crea algo hermoso que represente tu amor'
                        ],
                        'gratitude': [
                            '📝 Escribe 3 cosas por las que estás agradecido hoy',
                            '📞 Llama a alguien para agradecerle',
                            '🎁 Haz algo bueno por otra persona',
                            '🌱 Practica la gratitud hacia ti mismo/a',
                            '🌟 Comparte tu gratitud en redes sociales'
                        ]
                    };
                    
                    return suggestions[emotion] || [
                        '🌱 Cuida de ti mismo/a hoy',
                        '💧 Mantente hidratado/a',
                        '😴 Asegúrate de dormir bien',
                        '🍎 Come algo nutritivo',
                        '🧘 Tómate 5 minutos para respirar'
                    ];
                },
                
                viewHistory() {
                    // Crear modal o nueva vista para mostrar historial detallado
                    const historyWindow = window.open('', '_blank', 'width=800,height=600');
                    const historyData = this.userHistory.map(entry => ({
                        fecha: new Date(entry.timestamp).toLocaleString(),
                        emoción: this.emotionMap[entry.emotion]?.label || entry.emotion,
                        puntuación: Math.round(entry.score * 100) + '%',
                        texto: entry.text.substring(0, 100) + (entry.text.length > 100 ? '...' : '')
                    }));
                    
                    const html = `
                        <html>
                            <head>
                                <title>Historial Emocional - ${this.name}</title>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 20px; }
                                    table { width: 100%; border-collapse: collapse; }
                                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                    th { background-color: #f2f2f2; }
                                    .positive { background-color: #d4edda; }
                                    .negative { background-color: #f8d7da; }
                                    .neutral { background-color: #fff3cd; }
                                </style>
                            </head>
                            <body>
                                <h1>📊 Tu Historial Emocional</h1>
                                <p>Hola ${this.name}, aquí tienes un resumen de tus emociones registradas:</p>
                                <table>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Emoción</th>
                                        <th>Intensidad</th>
                                        <th>Texto</th>
                                    </tr>
                                    ${historyData.map(entry => `
                                        <tr class="${this.emotionMap[entry.emoción.toLowerCase()]?.type || 'neutral'}">
                                            <td>${entry.fecha}</td>
                                            <td>${entry.emoción}</td>
                                            <td>${entry.puntuación}</td>
                                            <td>${entry.texto}</td>
                                        </tr>
                                    `).join('')}
                                </table>
                            </body>
                        </html>
                    `;
                    
                    historyWindow.document.write(html);
                    historyWindow.document.close();
                },
                
                clearHistory() {
                    if (confirm('¿Estás seguro/a de que quieres eliminar todo tu historial emocional? Esta acción no se puede deshacer.')) {
                        this.userHistory = [];
                        localStorage.removeItem('emotionHistory');
                        localStorage.removeItem('currentMood');
                        alert('Historial eliminado. Tus datos están seguros y privados.');
                    }
                },
                
                exportData() {
                    const data = {
                        name: this.name,
                        history: this.userHistory,
                        exportDate: new Date().toISOString(),
                        version: '2.0'
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `historial-emocional-${this.name}-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }
        }).mount('#app');
    </script>

</body>

</html>
